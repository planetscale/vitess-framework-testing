#!/bin/bash

# General setup
git submodule update --init;

VT_USERNAME=${VT_USERNAME:-"root"}
VT_PASSWORD=${VT_PASSWORD:-"root"}
VT_HOST=${VT_HOST:-"127.0.0.1"}
VT_PORT=${VT_PORT:-"3306"}
VT_DATABASE=${VT_DATABASE:-"vitess"}

username=$VT_USERNAME
password=$VT_PASSWORD
host=$VT_HOST
port=$VT_PORT
database=$VT_DATABASE

# TODO:  There's a huge opportunity for parallelism here
for language in $(find . -mindepth 3 -maxdepth 3 -type f -name test | sed 's:^\./::' | xargs dirname | xargs dirname | sort -u); do
	echo "${language}:";
	for framework in $(find "${language}" -mindepth 2 -maxdepth 2 -type f -name test | sed 's:^\./::' | xargs dirname | xargs -n1 basename); do
		pushd "${language}/${framework}" >/dev/null;
		./test "${VITESS_DATABASE_URL}" &>/dev/null;
		echo "  ${framework}: $?";
		popd >/dev/null;
		tables="$(mysql --host "${host}" --port "${port}" --user "${username}" "-p${password}" "${database}" -Ne 'SHOW TABLES' 2>/dev/null | sed 's/^\|$/`/g' | xargs echo | sed 's/ /,/g')";
		if [[ "${tables}" != '' ]]; then
			mysql --host "${host}" --port "${port}" --user "${username}" "-p${password}" "${database}" -Ne "DROP TABLE ${tables}" &>/dev/null;
		fi;
	done
done

